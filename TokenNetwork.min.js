function TokenNetwork(t){let e=this;initialize(e),t=t||{},Object.keys(t).forEach(function(n){e[n]=t[n]})}function initialize(t){let e=null,n=null,r=null,o=[],i=.1,a=null,l=[" "],s=["\n"],c=[".",",",";","!","'","(",")",":","?"],u=[],f=null,p=null,h=null,g=null,d=function(){n=null,r=null,e=null,h=null,f=null,p=null};Object.defineProperty(t,"tokenMaxLength",{get:function(){return null===e&&(e=t.tokens.reduce((t,e)=>Math.max(t,e.length),0)),e}}),Object.defineProperty(t,"paragraphs",{get:function(){let t=[];return u.forEach(function(e){t=t.concat(e)}),t}}),Object.defineProperty(t,"tokens",{get:function(){return null===n&&(n=[],t.paragraphs.forEach(function(t){t.forEach(function(t){-1===n.indexOf(t)&&n.push(t)})}),n=n.sort(function(t,e){let n=t.length-e.length;return 0===n&&(n=t.localeCompare(e)),n})),n},set:function(t){t||d()}}),Object.defineProperty(t,"tokensWeights",{get:function(){if(null===r){let t=this;r=[],t.tokens.forEach(function(e){r[e]=t.getTokenWeight(e)})}return r}}),Object.defineProperty(t,"characters",{get:function(){return o},set:function(t){o=[...new Set(t)].sort((t,e)=>t.charCodeAt(0)-e.charCodeAt(0)),d()}}),Object.defineProperty(t,"charactersCount",{get:function(){return o.length}}),Object.defineProperty(t,"learningRate",{get:function(){return i},set:function(t){i=t}}),Object.defineProperty(t,"letterSeparators",{get:function(){return l},set:function(t){l=[...new Set(t)].sort(),d()}}),Object.defineProperty(t,"paragraphSeparators",{get:function(){return s},set:function(t){s=[...new Set(t)].sort(),d()}}),Object.defineProperty(t,"tokenSeparators",{get:function(){return c},set:function(t){c=[...new Set(t)].sort(),d()}}),Object.defineProperty(t,"data",{get:function(){return u}}),Object.defineProperty(t,"trainingData",{get:function(){let e=[];t.units;return u.forEach(function(n){e=e.concat(n.map(function(e){return e.map(e=>t.getTokenWeight(e))}))}),e}}),Object.defineProperty(t,"tokenInterval",{get:function(){return null===f&&(f=Math.pow(t.charactersCount,t.tokenMaxLength)),f}}),Object.defineProperty(t,"lineInterval",{get:function(){if(null===p){let e=t.paragraphs.length,n=2;do{p=Math.pow(2,n),n++}while(p<e)}return p}}),Object.defineProperty(t,"maxParagraphLength",{get:function(){return t.paragraphs.reduce((t,e)=>Math.max(t,e.length),0)}}),Object.defineProperty(t,"units",{get:function(){if(null===h){let e=2,n=t.maxParagraphLength,r=2;for(;r<n;)r=Math.pow(2,e),e++;h=r}return h}}),Object.defineProperty(t,"model",{get:function(){if(null===g){let e=t.units,n=tf.sequential(),r=tf.layers.simpleRNN({units:1,returnSequences:!0,activation:"linear"}),o=tf.input({shape:[e,1]});r.apply(o),n.add(r),n.compile({loss:tf.losses.meanSquaredError,optimizer:tf.train.sgd(t.learningRate)}),g=n}return g},set:function(t){g=t}}),Object.defineProperty(t,"loss",{set:function(t){isNaN(t)||(a=t)},get:function(){return a}})}const tf=require("@tensorflow/tfjs-node-gpu"),path=require("path"),fs=require("fs"),TextUtils=require("./TextUtils");TokenNetwork.prototype.loadTextFile=function(t){let e=this;return e.loadText(fs.readFileSync(t,{encoding:"utf-8"})),e},TokenNetwork.prototype.loadText=function(t){let e=this;t=TextUtils.cleanText(t),e.characters=e.characters.concat(TextUtils.charactersFromText(t));let n=TextUtils.split(t,e.paragraphSeparators).map(function(t){let n=[];return TextUtils.split(t,e.letterSeparators).forEach(function(t){n=n.concat(TextUtils.split(t,e.tokenSeparators,!0))}),n});return e.data.push(n),e.tokens=null,this},TokenNetwork.prototype.lineTo3d=function(t){let e=this,n=e.units,r=[...t];for(;r.length<n;)r.push(0);return tf.tensor(r,[1,n,1]).arraySync()[0]},TokenNetwork.prototype.train=async function(t,e){let n=this,r=n.trainingData,o=(n.units,[]),i=[],a=(n.lineInterval,[0]);for(let t=0;t<r.length;t++)for(let e=0;e<r[t].length;e++){let l;if(0===e){if(null===a)continue;l=a}else l=r[t].slice(0,e);let s=r[t].slice(0,e+1);if(0===s.filter(t=>t>0).length)break;let c=n.lineTo3d(l),u=n.lineTo3d(s);a=s,o.push(c),i.push(u)}t=t||100;let l=0;do{let r=n.model,a=tf.tensor(o),s=tf.tensor(i);await r.fit(a,s,{epochs:t,verbose:0,callbacks:{onEpochEnd:function(o,i){l=i.loss,!isNaN(l)&&e?(n.loss=l,e(o+1,t,l)):(r.stopTraining=!0,n.incrementLearningRate(),n.model=null)}}})}while(isNaN(l))},TokenNetwork.prototype.predict=function(t,e){let n,r=this,o=(r.model,[0]);e=e||1;r.units;let i=[];for(;i.length<e;)console.log(r.lineTo3d(o)),process.exit(),console.log(n),process.exit(),o=tf.tensor([n]);let a=results=o.flatten().arraySync().filter(t=>t>=0).map(function(t){return r.getNearestToken(t)}).join(" ");return process.exit(),a.push(results),a.join("\n")},TokenNetwork.prototype.toJSON=function(){let t=this;return{learningRate:t.learningRate,loss:t.loss,characters:t.characters,letterSeparators:t.letterSeparators,paragraphSeparators:t.paragraphSeparators,tokenSeparators:t.tokenSeparators}},TokenNetwork.prototype.save=async function(t){let e=this,n=e.model;fs.existsSync(t)||fs.mkdirSync(t,{recursive:!0}),await n.save("file://"+t),fs.writeFileSync(path.join(t,"data.json"),JSON.stringify(this,null,4))},TokenNetwork.prototype.load=async function(t){let e=this;if(fs.existsSync(t)){let n=path.join(t,"data.json");if(fs.existsSync(n)){let t=JSON.parse(fs.readFileSync(n,{encoding:"utf-8"}));Object.keys(t).forEach(function(n){e[n]=t[n]})}let r=path.join(t,"model.json");if(fs.existsSync(r)){let t=await tf.load("file://"+r);t.compile({loss:tf.losses.meanSquaredError,optimizer:tf.train.sgd(e.learningRate)}),e.model=t}}},TokenNetwork.prototype.weightToToken=function(t){let e=this,n=e.charactersCount,r=e.tokenInterval*t,o=[];for(;r>0;)o.push(r%n),r=Math.floor(r/n);return o.map(t=>e.characters[t]?e.characters[t]:null).filter(t=>null!==t).join("")},TokenNetwork.prototype.getNearestToken=function(t){let e=this,n=parseInt(t)-1;return n>=0&&e.tokens[n]?e.tokens[n]:null},TokenNetwork.prototype.getTokenWeight=function(t){return this.tokens.indexOf(t)+1},TokenNetwork.prototype.incrementLearningRate=function(){let t=this,e=0,n=String(t.learningRate).split(".");return n[1]&&(e=n[1].length),t.learningRate=1/Math.pow(10,e+1),t},module.exports=TokenNetwork;